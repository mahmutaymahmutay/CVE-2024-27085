
########################################################################################
##                                                                                    ##
##    This Python Script detects CVE-2024-27085 Vulnerability in ESXI                 ##
##                                                                                    ##
##    Author: MahmutAy  <mahmutayy@yahoo.com>                                         ##
##                                                                                    ##
##       This is only educational purpose  or bussiness usage                         ##
##    !!  Do not attempt to violate the laws with anything contained here. !!!        ##
##                                                                                    ##                                                                        
########################################################################################

# Before the using this detector , you must create a  json file named " assets.json" which includes Devices' informations  
import json
import paramiko 

def check_esxi_auth_bypass(hostname, port, username, password):
    try:
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        client.connect(hostname, port=port, username=username, password=password)
        
        stdin, stdout, stderr = client.exec_command('tail -n 100 /var/log/auth.log')
        auth_log = stdout.read().decode()

        if "authentication bypass" in auth_log or "login anomaly" in auth_log:
            print(f"Potential auth bypass vulnerability exploitation detected on {hostname}")
        else:
            print(f"No signs of CVE-2024-37085 exploitation detected on {hostname}")

        client.close()
    except paramiko.AuthenticationException:
        print(f"Authentication failed for {hostname}")
    except paramiko.SSHException as sshException:
        print(f"Unable to establish SSH connection to {hostname}: {sshException}")
    except Exception as e:
        print(f"Error occurred: {e}")

if __name__ == "__main__":
    # Load cata from JSON file
    with open('assets.json', 'r') as assets_file:
        config = json.load(assets_file)

    devices = config["devices"]

    for device in devices:
        hostname = device["hostname"]
        port = device["port"]
        username = device["username"]
        password = device["password"]

        print(f"Checking device: {hostname}")
        check_esxi_auth_bypass(hostname, port, username, password)
